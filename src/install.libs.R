## install.libs.R## copyright (c) 2012 Danny Arends# last modified Jan, 2012# first written Jan, 2012# testDMD <- function(){  r <- 0  if(WINDOWS){    r <- system("dmd -quiet --help",show.output.on.console=FALSE, ignore.stdout = TRUE)  }else{    r <- system("dmd -quiet --help", ignore.stdout = TRUE)  }  if(r != 0){    stop("** ERROR ** No DMD compiler found\nAvailable at: http://www.digitalmars.com/d/download.html")  }else{    cat("** DMD compiler found\n")  }}doDMDcompilation <- function(command, verbose = FALSE){  if(verbose) cat("\n\n: ",command,"\n\n")  if(system(command)!=0){    cat("\n\n: ",command,"\n\n")    stop("** ERROR ** Compilation error for:", command)  }}testDMD()dfilelocation <- paste(R_PACKAGE_SOURCE, "/exec/",sep="")qtlhd_location <- paste(dfilelocation, "qtlHD/src/D/",sep="")flags <- "-O -inline -release"core_files <- paste(Sys.glob(paste(qtlhd_location, "qtl/core/*.d",sep="")),collapse=" ")core_map_files <- paste(Sys.glob(paste(qtlhd_location, "qtl/core/map/*.d",sep="")),collapse=" ")core_hmm_files <- paste(Sys.glob(paste(qtlhd_location, "qtl/core/hmm/*.d",sep="")),collapse=" ")core_util_files <- paste(Sys.glob(paste(qtlhd_location, "qtl/core/util/*.d",sep="")),collapse=" ")core_scan_files <- paste(Sys.glob(paste(qtlhd_location, "qtl/core/scanone/*.d",sep="")),collapse=" ")core_mqm_files <- paste(Sys.glob(paste(qtlhd_location, "qtl/core/mqm/*.d",sep="")),collapse=" ")if(WINDOWS){  cat("*** Compiling shared library: qtlHD.dll\n")  Dfiles <- paste(Sys.glob(paste(dfilelocation,c("D/*.d","D/dll/*","D/libs/*.d"),sep="")),collapse=" ")  doDMDcompilation(paste("dmd -ofqtlHD.dll -L/IMPLIB ",flags," ",Dfiles," "," ",core_files," phobos.lib -IC:/D/dmd2/windows/bin",sep=""))}else{  cat("*** Compiling shared library: qtlHD.so\n")  Dfiles <- paste(Sys.glob(paste(dfilelocation,c("D/*.d","D/dll/*.d","D/libs/*.d"),sep="")),collapse=" ")  doDMDcompilation(paste("dmd -c -fPIC ",flags," "," ",Dfiles," ",core_files," ", sep=""))  doDMDcompilation(paste("g++ -fPIC -shared -o qtlHD.so *.o -llapack -lblas -lgfortran -lm -lphobos2 -L/usr/lib/R/lib -lR"))}files <- Sys.glob(paste("*", SHLIB_EXT, sep=''))libarch <- if (nzchar(R_ARCH)) paste('libs', R_ARCH, sep='') else 'libs'dest <- file.path(R_PACKAGE_DIR, libarch)dir.create(dest, recursive = TRUE, showWarnings = FALSE)file.copy(files, dest, overwrite = TRUE)file.remove(Sys.glob(paste("*", SHLIB_EXT, sep='')))file.remove(Sys.glob("*.o"))file.remove(Sys.glob("*.lib"))file.remove(Sys.glob("*.obj"))file.remove(Sys.glob("*.dll"))